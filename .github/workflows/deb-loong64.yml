name: Build and Release for LoongArch

on:
  push:
    tags: [ "v*" ]

jobs:
  package:
    runs-on: loong64
    strategy:
      matrix:
        container-image:
          - lcr.loongnix.cn/library/debian:sid-20251209
    container:
      image: ${{ matrix.container-image }}
    
    steps:
      - name: 1. 安装系统依赖
        run: |
          apt-get update
          apt-get install -y build-essential curl pkg-config

      - name: 2. 检出代码
        uses: actions/checkout@v4

      - name: 3. 安装 Rust 工具链
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: loongarch64-unknown-linux-gnu
          cache: false

      - name: 4. 编译 Release 版本
        run: cargo build --release --target=loongarch64-unknown-linux-gnu

      - name: 5. 准备发布产物
        run: |
          mkdir -p release-artifacts
          BINARY_NAME="loongson-minitool"
          cp target/loongarch64-unknown-linux-gnu/release/$BINARY_NAME release-artifacts/
          chmod +x release-artifacts/$BINARY_NAME
          tar -czf "loongson-minitool-loongarch64-${{ matrix.container-image##*/ }}.tar.gz" -C release-artifacts .
          echo "ARTIFACT_NAME=loongson-minitool-loongarch64-${{ matrix.container-image##*/ }}.tar.gz" >> $GITHUB_ENV

      - name: 6. 上传构建产物（暂存）
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_NAME }}
          retention-days: 7

  release:
    runs-on: ubuntu-latest
    needs: [package]
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    
    steps:
      - name: 1. 下载所有暂存的构建产物
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts
          merge-multiple: true

      - name: 2. 创建 GitHub Release 并上传文件
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Loongson Minitool ${{ github.ref_name }} for LoongArch64.
            Built in native LoongArch64 containers.
          files: |
            ./all-artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
