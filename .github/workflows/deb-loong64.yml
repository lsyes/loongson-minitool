name: deb-build

on:
  push:
    tags: [ "v*" ]

jobs:
  package:
    name: Build & Package (LoongArch64)
    runs-on: loong64
    strategy:
      fail-fast: false
      matrix:
        target:
          - "lcr.loongnix.cn/library/debian:sid-20251209"
    container:
      image: "${{ matrix.target }}"
    
    steps:
      - name: 1. Install System Dependencies
        shell: bash
        env:
          TARGET_DISTRO: "${{ matrix.target }}"
        run: |
          if [[ "${TARGET_DISTRO}" == *"deepin"* ]]; then
            sed -e 's|https://community-packages.deepin.com|https://mirrors.bfsu.edu.cn/deepin|g' -i /etc/apt/sources.list
          fi
          
          apt-get update
          env DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential pkgconf nettle-dev libapt-pkg-dev curl xz-utils \
            clang openssh-client rsync libbz2-dev liblzma-dev libzstd-dev \
            nodejs locales git
            
      - name: 2. Checkout Repository
        uses: actions/checkout@v4

      - name: 3. Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true 

      - name: 4. Install cargo-deb
        run: cargo install cargo-deb

      - name: 5. Build Project & Generate Assets
        shell: bash
        run: |
          export ZSTD_SYS_USE_PKG_CONFIG=1
          
          localedef -i zh_CN -f UTF-8 zh_CN.UTF-8
          localedef -i zh_TW -f UTF-8 zh_TW.UTF-8
          
          cargo build --release --no-default-features --features nice-setup
          

      - name: 6. Create Deb Package & Rename
        shell: bash
        env:
          TARGET_DISTRO: "${{ matrix.target }}"
        run: |
          cargo deb -Z xz
          
          if [[ "${TARGET_DISTRO}" == *"debian"* ]]; then
             CODENAME='trixie'
             VER_SUFFIX='debian13'
          elif [[ "${TARGET_DISTRO}" == *"deepin"* ]]; then
             CODENAME='beige'
             VER_SUFFIX='deepin23'
          else
             TMP_SUFFIX="${TARGET_DISTRO##*/}"
             VER_SUFFIX="${TMP_SUFFIX/:/_}"
             CODENAME="unknown"
          fi
          
          for file in target/debian/*.deb; do
            mv -v "${file}" "${file/\.deb/-${VER_SUFFIX}.deb}"
          done
          
          echo "VER_SUFFIX=${VER_SUFFIX}" >> $GITHUB_ENV
          echo "CODENAME=${CODENAME}" >> $GITHUB_ENV

      - name: 7. Upload to Custom Repository (loongnix)
        if: ${{ secrets.USER != '' && secrets.KEY != '' }}
        env:
          KEY: ${{ secrets.KEY }}
          USER: ${{ secrets.USER }}
        run: |
          mkdir -p ~/.ssh/ && chmod 0700 ~/.ssh/
          echo "$KEY" > ~/.ssh/id_ed25519 && chmod 0600 ~/.ssh/id_ed25519
          cp .github/workflows/known_hosts ~/.ssh/known_hosts || ssh-keyscan repo.aosc.io >> ~/.ssh/known_hosts
          chmod 0600 ~/.ssh/known_hosts
          
          rsync --ignore-existing -v -e "ssh -o IdentityFile=$HOME/.ssh/id_ed25519" \
            target/debian/*-"${VER_SUFFIX}".deb \
            ${USER}@repo.aosc.io:/mirror/oma/pool/"${CODENAME}"/main/o/
            
          ssh -o IdentityFile=~/.ssh/id_ed25519 ${USER}@repo.aosc.io "touch /mirror/.updated"

      - name: 8. Upload Artifacts (For Release)
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ env.VER_SUFFIX }}
          path: target/debian/*.deb
          retention-days: 1

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: package
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true 

      - name: List Files (Debug)
        run: ls -R release-assets

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*.deb
          body: |
            ## Oma ${{ github.ref_name }}
            
            LoongArch64 构建产物 (Debian/Loongnix/Deepin)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
