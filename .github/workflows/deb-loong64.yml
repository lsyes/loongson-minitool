name: Build LoongArch Binary and Release

on:
  push:
    tags: [ "v*" ]

jobs:
  package:
    runs-on: loong64
    strategy:
      matrix:
        target:
          - "lcr.loongnix.cn/library/debian:sid-20251209"
    container:
      image: "${{ matrix.target }}"
    steps:
      - name: 1. 配置环境与安装依赖
        shell: bash
        env:
          TARGET_DISTRO: "${{ matrix.target }}"
        run: |
          apt-get update
          env DEBIAN_FRONTEND=noninteractive apt-get install -y build-essential curl pkg-config

      - name: 2. 检出代码
        uses: actions/checkout@v4

      - name: 3. 安装 Rust 工具链
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: loongarch64-unknown-linux-gnu
          cache: false

      - name: 4. 构建 Release 二进制文件
        run: cargo build --release --target=loongarch64-unknown-linux-gnu

      - name: 5. 准备发布产物
        shell: bash
        env:
          TARGET_DISTRO: "${{ matrix.target }}"
        run: |
          VER_SUFFIX="${TARGET_DISTRO/:/}"
          VER_SUFFIX="${VER_SUFFIX##*/}"
          
          case "${TARGET_DISTRO}" in
              *"debian:sid"*)
                  DISTRO_NAME="debian-sid"
                  ;;
              *"ubuntu:jammy"*)
                  DISTRO_NAME="ubuntu-22.04"
                  ;;
              *)
                  DISTRO_NAME="${TARGET_DISTRO##*/}"
                  DISTRO_NAME="${DISTRO_NAME/:/_}"
                  ;;
          esac
          
          BINARY_NAME="loongson-minitool"
          RELEASE_DIR="release-$DISTRO_NAME"
          
          mkdir -p "$RELEASE_DIR"
          cp "target/loongarch64-unknown-linux-gnu/release/$BINARY_NAME" "$RELEASE_DIR/"
          
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          tar -czf "loongson-minitool_${TAG_NAME}_loongarch64_$DISTRO_NAME.tar.gz" -C "$RELEASE_DIR" .
          
          echo "ARTIFACT_NAME=loongson-minitool_${TAG_NAME}_loongarch64_$DISTRO_NAME.tar.gz" >> $GITHUB_ENV
          echo "ARTIFACT_PATH=loongson-minitool_${TAG_NAME}_loongarch64_$DISTRO_NAME.tar.gz" >> $GITHUB_ENV
          echo "DISTRO_NAME=$DISTRO_NAME" >> $GITHUB_ENV

      - name: 6. 暂存构建产物
        uses: actions/upload-artifact@v4
        with:
          name: binary-pkg-${{ env.DISTRO_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 7

  release:
    runs-on: ubuntu-latest
    needs: [package]
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: 1. 下载所有暂存的产物
        uses: actions/download-artifact@v4
        with:
          path: ./release-assets
          merge-multiple: true

      - name: 2. 创建 GitHub Release 并上传文件
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Loongson Minitool ${{ github.ref_name }}
            专为 LoongArch64 架构构建的原生二进制文件。
          files: |
            ./release-assets/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
